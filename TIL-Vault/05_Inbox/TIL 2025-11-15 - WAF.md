---
created: 2025-11-15 00:04
updated: 2025-11-15 00:04
status:
  - draft
tags:
source:
---
# 📝 TIL 2025-11-15 - WAF

> **관련 주제:** [[MOC_TBD]] 

## 🚀 개요 및 핵심 (Summary)

WAS(Tomcat)와 마찬가지로 WAF는 웹 애플리케이션의 **인프라 보안 계층**에 속합니다.
$$\text{Client} \rightarrow \text{Load Balancer} \rightarrow \text{WAF} \rightarrow \text{WAS} \rightarrow \text{Spring Application}$$
WAF는 **모든 HTTP 요청이 서버에 도달하기 전에** 요청의 내용을 분석하고 악성 트래픽을 차단할 수 있는 **1차 방어선** 역할을 수행합니다.

## 📚 상세 내용 (Deep Dive)

WAF(Web Application Firewall)는 데이터를 읽고 넘기는 과정에서 **일반적으로 문제가 없습니다**. 이는 WAF가 **프록시(Proxy)** 형태로 동작하며, 데이터의 스트림 특성을 처리할 수 있도록 설계되었기 때문입니다. 🛡️

---

## 1. 🔍 WAF의 동작 방식: 리버스 프록시

WAF는 WAS(Web Application Server)의 **앞단**에서 리버스 프록시(Reverse Proxy)처럼 작동합니다.

- **수신 및 버퍼링:** WAF는 클라이언트로부터 HTTP 요청을 수신하면, 요청을 **완전히 수집(버퍼링)**합니다. 이 과정에서 Start Line, Header, 그리고 **Body 전체**를 읽어 메모리에 저장합니다.
    
- **분석:** WAF는 저장된 데이터 전체를 대상으로 SQL Injection 패턴, XSS 스크립트 등 **악성 공격 패턴**을 분석합니다.
    
- **재전송:** 분석을 통과하면, WAF는 요청을 **자신이 직접** WAS로 **새롭게 생성하여 포워딩(forward)**하거나, WAS로 연결된 기존 소켓을 통해 데이터를 **다시 스트리밍**하여 전달합니다.

|**기능**|**설명**|**예시 공격 차단**|
|---|---|---|
|**애플리케이션 계층 보호**|HTTP 요청과 응답 메시지의 내용을 분석하여 악성 패턴을 탐지합니다.|**SQL Injection, XSS, Command Injection** 등 알려진 웹 취약점 패턴 차단|
|**세션 관리 및 인증**|세션 토큰이나 쿠키를 분석하여 세션 하이재킹이나 세션 조작 시도를 방어합니다.|**세션 하이재킹, 인증 우회**|
|**접근 제어 및 속도 제한**|특정 IP나 봇의 과도한 요청을 감지하고 차단하여 서버 부하를 줄입니다.|**DDoS 공격(L7 계층), 무차별 대입 공격 (Brute-Force)**|
|**강제 브라우징 방어**|사용자가 접근 권한이 없는 URL이나 디렉터리에 접근하는 것을 방지합니다.|**민감한 파일 노출 방지**|

## 2. 💡 WAF가 Request Body 문제를 회피하는 이유

WAF는 Spring의 $\text{Filter}$가 겪는 **'스트림 소진'** 문제를 근본적으로 우회합니다.

- **완전한 통제:** WAF는 OS의 네트워크 스택을 통해 데이터를 받는 소프트웨어이므로, $\text{HttpServletRequest}$와 같은 **Java Servlet 표준의 제약**을 받지 않습니다.
    
- **캐싱과 재생성:** WAF는 $\text{Filter}$에서 사용하는 $\text{ContentCachingRequestWrapper}$와 유사하게, 요청 데이터를 **전체 캐싱**합니다. 분석을 위해 한 번 읽어 저장한 후, WAS로 넘길 때는 **저장된 캐시를 기반으로 새로운 요청**을 만들거나 스트림을 다시 생성하여 WAS로 보내기 때문에, WAS는 데이터를 **'처음 받는'** 것처럼 인식합니다.

